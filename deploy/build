#!/bin/bash

# This script is called by identity-devops cookbooks as part of the deployment
# process. It runs build steps needed to complete building the application,
# such as vendoring ruby/nodejs libraries and compiling static assets.
# Then the deploy/activate script is called to instantiate live configuration
# and take steps at runtime.

set -euo pipefail

echo "deploy/build starting"
echo "HOME: ${HOME-}"
cd "$(dirname "$0")/.."

set -x

env

id
which bundle
# default bundle directory to shared directory
: ${BUNDLE_DIR=/srv/idp/shared/bundle}

# use system libxml2, not the one vendored with nokogiri
bundle config build.nokogiri --use-system-libraries
bundle config set --local deployment 'true'
bundle config set --local path $BUNDLE_DIR
bundle config set --local without 'deploy development doc test'

bundle install --jobs 4
bundle binstubs --all

yarn install --production --frozen-lockfile

set +x

echo "deploy/build finished"
