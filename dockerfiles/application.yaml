apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ENVIRONMENT}}
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: 'git@gitlab.login.gov:lg-public/identity-eks-control.git'
    targetRevision: sshelton/update-reviewapp
    path: cluster-reviewapp/envs/reviewapps
    kustomize:
      namePrefix: "{{ENVIRONMENT}}-"
      commonLabels:
        env: {{ENVIRONMENT}}
        branch: {{SANITIZED_BRANCH_NAME}}
      # ArgoCD does not support patchesStrategicMerge
      patches:
        # Patch ConfigMap for IDP
        - target:
            kind: ConfigMap
            name: idp-config
          patch: |-
            - op: add
              path: /data/ASSET_HOST
              value: "https://{{ENVIRONMENT}}.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/DASHBOARD_URL
              value: "https://{{ENVIRONMENT}}-dashboard.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/DOMAIN_NAME
              value: "{{ENVIRONMENT}}.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/KUBERNETES_REVIEW_APP
              value: "true"
            - op: add
              path: /data/POSTGRES_HOST
              value: "{{ENVIRONMENT}}-idp-pg.review-apps"
            - op: add
              path: /data/POSTGRES_NAME
              value: "idp"
            - op: add
              path: /data/POSTGRES_SSLMODE
              value: "prefer"
            - op: add
              path: /data/LOGIN_ENV
              value: "{{ENVIRONMENT}}"
            - op: add
              path: /data/LOGIN_HOST_ROLE
              value: "idp"
            - op: add
              path: /data/LOGIN_SKIP_REMOTE_CONFIG
              value: "true"
            - op: add
              path: /data/PIV_CAC_SERVICE_URL
              value: "https://{{ENVIRONMENT}}.pivcac.reviewapps.identitysandbox.gov/"
            - op: add
              path: /data/PIV_CAC_VERIFY_TOKEN_URL
              value: "https://{{ENVIRONMENT}}.pivcac.reviewapps.identitysandbox.gov/"
        # Patch ConfigMap for Worker
        - target:
            kind: ConfigMap
            name: worker-config
          patch: |-
            - op: add
              path: /data/DASHBOARD_URL
              value: "https://{{ENVIRONMENT}}-dashboard.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/KUBERNETES_REVIEW_APP
              value: "true"
            - op: add
              path: /data/POSTGRES_SSLMODE
              value: "prefer"
            - op: add
              path: /data/POSTGRES_NAME
              value: "idp"
            - op: add
              path: /data/POSTGRES_HOST
              value: "{{ENVIRONMENT}}-idp-pg.review-apps"
            - op: add
              path: /data/LOGIN_ENV
              value: "{{ENVIRONMENT}}"
            - op: add
              path: /data/LOGIN_HOST_ROLE
              value: "worker"
            - op: add
              path: /data/LOGIN_SKIP_REMOTE_CONFIG
              value: "true"
            - op: add
              path: /data/PIV_CAC_SERVICE_URL
              value: "https://{{ENVIRONMENT}}.pivcac.reviewapps.identitysandbox.gov/"
            - op: add
              path: /data/PIV_CAC_VERIFY_TOKEN_URL
              value: "https://{{ENVIRONMENT}}.pivcac.reviewapps.identitysandbox.gov/"
            - op: add
              path: /data/DOMAIN_NAME
              value: "{{ENVIRONMENT}}.reviewapps.identitysandbox.gov"
        # Patch ConfigMap for PIVCAC
        - target:
            kind: ConfigMap
            name: pivcac-config
          patch: |-
            - op: add
              path: /data/KUBERNETES_REVIEW_APP
              value: "true"
            - op: add
              path: /data/CLIENT_CERT_S3_BUCKET
              value: "login-gov-pivcac-public-cert-reviewapps.894947205914-us-west-2"
            - op: add
              path: /data/POSTGRES_NAME
              value: "identity_pki_production"
            - op: add
              path: /data/POSTGRES_HOST
              value: "{{ENVIRONMENT}}-pivcac-pg.review-apps"
            - op: add
              path: /data/IDP_HOST
              value: "{{ENVIRONMENT}}.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/DOMAIN_NAME
              value: "{{ENVIRONMENT}}.pivcac.reviewapps.identitysandbox.gov"
        # Patch ConfigMap for Dashboard
        - target:
            kind: ConfigMap
            name: dashboard-config
          patch: |-
            - op: add
              path: /data/KUBERNETES_REVIEW_APP
              value: "true"
            - op: add
              path: /data/POSTGRES_NAME
              value: "dashboard"
            - op: add
              path: /data/POSTGRES_HOST
              value: "{{ENVIRONMENT}}-dashboard-pg.review-apps"
            - op: add
              path: /data/POSTGRES_SSLMODE
              value: "prefer"
            - op: add
              path: /data/NEW_RELIC_ENABLED
              value: "false"
            - op: add
              path: /data/SAML_SP_ISSUER
              value: "https://{{ENVIRONMENT}}-dashboard.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/IDP_URL
              value: "https://{{ENVIRONMENT}}.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/IDP_SP_URL
              value: "https://{{ENVIRONMENT}}.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/POST_LOGOUT_URL
              value: "https://{{ENVIRONMENT}}-dashboard.reviewapps.identitysandbox.gov"
            - op: add
              path: /data/DOMAIN_NAME
              value: "https://{{ENVIRONMENT}}-dashboard.reviewapps.identitysandbox.gov"
        # Patch ConfigMap for Dashboard service_providers.yml
        - target:
            kind: ConfigMap
            name: service-providers-yml
          patch: |-
            - op: replace
              path: /data/service_providers.yml
              value: |
                production:
                  'urn:gov:gsa:openidconnect.profiles:sp:sso:gsa:dashboard':
                    friendly_name: 'Dashboard'
                    agency: 'GSA'
                    agency_id: 2
                    logo: '18f.svg'
                    certs:
                      - 'identity_dashboard_cert'
                    return_to_sp_url: 'https://dashboard.{{ENVIRONMENT}}.identitysandbox.gov/'
                    redirect_uris:
                      - 'https://dashboard.{{ENVIRONMENT}}.identitysandbox.gov/auth/logindotgov/callback'
                      - 'https://dashboard.{{ENVIRONMENT}}.identitysandbox.gov'
                    push_notification_url: 'https://dashboard.{{ENVIRONMENT}}.identitysandbox.gov/api/security_events'
        # Patch for IDP StatefulSet
        - target:
            kind: StatefulSet
            name: idp-pg
          patch: |-
            - op: replace
              path: /spec/volumeClaimTemplates/0/metadata/name
              value: {{ENVIRONMENT}}-idp-data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/name
              value: {{ENVIRONMENT}}-idp-data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/mountPath
              value: /var/lib/postgresql/data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/subPath
              value: postgres
        # Patch for PIVCAC StatefulSet
        - target:
            kind: StatefulSet
            name: pivcac-pg
          patch: |-
            - op: replace
              path: /spec/volumeClaimTemplates/0/metadata/name
              value: {{ENVIRONMENT}}-pivcac-data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/name
              value: {{ENVIRONMENT}}-pivcac-data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/mountPath
              value: /var/lib/postgresql/data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/subPath
              value: postgres
        # Patch for Dashboard StatefulSet
        - target:
            kind: StatefulSet
            name: dashboard-pg
          patch: |-
            - op: replace
              path: /spec/volumeClaimTemplates/0/metadata/name
              value: {{ENVIRONMENT}}-dashboard-data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/name
              value: {{ENVIRONMENT}}-dashboard-data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/mountPath
              value: /var/lib/postgresql/data
            - op: replace
              path: /spec/template/spec/containers/0/volumeMounts/0/subPath
              value: postgres
        # Patch idp database setup jobs
        - target:
            kind: Job
            name: create-database
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-idp/review:{{IDP_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-idp-application-yml
            - op: replace
              path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
              value: {{ENVIRONMENT}}-idp-config
        - target:
            kind: Job
            name: migrate-database
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-idp/review:{{IDP_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-idp-application-yml
            - op: replace
              path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
              value: {{ENVIRONMENT}}-idp-config
        - target:
            kind: Job
            name: seed-database
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-idp/review:{{IDP_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-idp-application-yml
            - op: replace
              path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
              value: {{ENVIRONMENT}}-idp-config
        # Patch dashboard database setup jobs
        - target:
            kind: Job
            name: create-dashboard-database
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-dashboard/review:{{DASHBOARD_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-dashboard-application-yml
            - op: replace
              path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
              value: {{ENVIRONMENT}}-dashboard-config
        - target:
            kind: Job
            name: migrate-dashboard-database
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-dashboard/review:{{DASHBOARD_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-dashboard-application-yml
            - op: replace
              path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
              value: {{ENVIRONMENT}}-dashboard-config
        - target:
            kind: Job
            name: seed-dashboard-database
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-dashboard/review:{{DASHBOARD_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-dashboard-application-yml
            - op: replace
              path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
              value: {{ENVIRONMENT}}-dashboard-config
        # Patch IDP image and configmaps and canary metrics
        - target:
            kind: Rollout
            name: idp-rollout
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-idp/review:{{IDP_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/initContainers/0/image
              value: {{ECR_REGISTRY}}/identity-idp/review:{{IDP_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-idp-application-yml
            - op: replace
              path: /spec/strategy/canary/analysis/args/0/value
              value: {{ENVIRONMENT}}-idp_reviewapps_svc_3000
            - op: replace
              path: /spec/strategy/canary/steps/2/analysis/args/0/value
              value: {{ENVIRONMENT}}-idp_reviewapps_svc_3000
        # Patch Worker Image and configmaps
        - target:
            kind: Deployment
            name: worker
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-idp/review:{{IDP_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-worker-application-yml
        # Patch PIVCAC Image and configmaps
        - target:
            kind: Deployment
            name: pivcac
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-pki/review:{{PIVCAC_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-pivcac-application-yml
        # Patch Dashboard Image configmaps
        - target:
            kind: Deployment
            name: dashboard
          patch: |-
            - op: replace
              path: /spec/template/spec/containers/0/image
              value: {{ECR_REGISTRY}}/identity-dashboard/review:{{DASHBOARD_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/initContainers/0/image
              value: {{ECR_REGISTRY}}/identity-dashboard/review:{{DASHBOARD_CONTAINER_TAG}}
            - op: replace
              path: /spec/template/spec/volumes/0/configMap/name
              value: {{ENVIRONMENT}}-dashboard-application-yml
        # Patch ingress names
        - target:
            kind: Ingress
            name: idp
          patch: |-
            - op: replace
              path: /metadata/annotations/alb.ingress.kubernetes.io~1group.name
              value: review-app
            - op: replace
              path: /spec/rules/0/host
              value: {{ENVIRONMENT}}.reviewapps.identitysandbox.gov
            - op: replace
              path: /spec/rules/0/http/paths/0/backend/service/name
              value: {{ENVIRONMENT}}-idp
        - target:
            kind: Ingress
            name: dashboard
          patch: |-
            - op: replace
              path: /metadata/annotations/alb.ingress.kubernetes.io~1group.name
              value: review-app-dashboard
            - op: replace
              path: /spec/rules/0/host
              value: {{ENVIRONMENT}}-dashboard.reviewapps.identitysandbox.gov
            - op: replace
              path: /spec/rules/0/http/paths/0/backend/service/name
              value: {{ENVIRONMENT}}-dashboard
            
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: review-apps
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true