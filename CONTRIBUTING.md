## Welcome!

We’re so glad you’re thinking about contributing to a Technology Transformation Services (TTS) open source project! If you’re unsure about anything, just ask — or submit your issue or pull request anyway. The worst that can happen is we’ll politely ask you to change something. We appreciate all friendly contributions.

TTS is committed to building a safe, welcoming, harassment-free culture for everyone. We expect everyone on the TTS team and everyone within TTS spaces, including contributors to our projects, to follow the [TTS Code of Conduct](https://github.com/18F/code-of-conduct/blob/master/code-of-conduct.md).

We encourage you to read this project’s CONTRIBUTING policy (you are here), its [LICENSE](LICENSE.md), [README](README.md)

If you have any questions or want to read more, check out the [18F Open Source Policy GitHub repository]( https://github.com/18f/open-source-policy), or [send us an email](mailto:18f@gsa.gov).


## Pull request guidelines

Below are rules we strive to follow to achieve maintainable and consistent code.

### Commit message style guide:

- Write your commit message summary in the imperative: "Fix bug" and not
"Fixed bug" or "Fixes bug."  This convention matches up with commit messages
generated by commands like `git merge` and `git revert`.

- Under the summary, start by explaining why this change is necessary, and
add details to help the person reviewing your code understand what your
pull request is about.

- If the pull request is in response to a Jira ticket, include the ticket ID in
the commit title (e.g. "LG-1234 Add the stuff to the thing")

- Include a changelog message which describes the changes in human-readable
terms. These messages are included in release notes, so they should be easy to
understand for our partners and users. In the rare case that a change should
not be included in release notes, add `[skip changelog]` to the commit.

Example:

```
LG-1235 Load seed using before(:suite) in RSpec config

**Why**:
- Loading the seed in a `before(:each)` block results in an unnecessary
database call before every single test, slowing down the test suite,
and making development less efficient.

**How**:
- Use `before(:suite)` instead, since the data that is loaded is not
meant to change, and so that only one database call is made.
- To prevent the data from being wiped out after each spec, configure
Database Cleaner to ignore those static tables.

changelog: Internal, Automated Testing, Improve performance of test suite
```

Refer to the [changelog check script] for a complete list of acceptable
changelog categories.

[changelog check script]: https://github.com/18F/identity-idp/blob/main/scripts/changelog_check.rb

### Style, Readability, and OO
- Rubocop or Reek offenses are not disabled unless they are false positives.
If you're not sure, please ask a teammate.

- Related methods in the same class are in descending order of abstraction.
This is best explained through this video: https://youtu.be/0rsilnpU1DU?t=554

- Compound conditionals are replaced with more readable methods that describe
the business rule. For example, a conditional like
`user_session[:personal_key].nil? && current_user.personal_key.present?` could
be extracted into a method called
`current_user_has_already_confirmed_their_personal_key?`.
Another example is explained in this video: https://youtu.be/0rsilnpU1DU?t=40s

- Service Objects should usually only have one public method, usually named
`call`. This mostly applies to classes that perform a specific task, unlike
Presenters, View Objects, and Value Objects, for example. Read
[7 Patterns to Refactor Fat ActiveRecord Models] for a good overview of the
different types of classes used in Rails.

  References:
  - https://medium.com/selleo/essential-rubyonrails-patterns-part-1-service-objects-1af9f9573ca1
  - https://multithreaded.stitchfix.com/blog/2015/06/02/anatomy-of-service-objects-in-rails/
  - https://hackernoon.com/the-3-tenets-of-service-objects-c936b891b3c2
  - http://katafrakt.me//2018/07/04/writing-service-objects/
  - https://pawelurbanek.com/2018/02/12/ruby-on-rails-service-objects-and-testing-in-isolation/

[7 Patterns to Refactor Fat ActiveRecord Models]: https://codeclimate.com/blog/7-ways-to-decompose-fat-activerecord-models/

### RESTful controllers

* Only use CRUD methods in controllers.

* Prefer adding a new controller with one of the CRUD methods over creating a
  custom method in an existing controller. For example, if your app allows a
  user to update their email and their password on two different pages, instead of
  using a single controller with methods called `update_email` and
  `update_password`, create two controllers and name the methods `update`, i.e.
  `EmailsController#update` and `PasswordsController#update`. See
  http://jeromedalbert.com/how-dhh-organizes-his-rails-controllers/ for more about
  this design pattern.

### Lean controllers
* Keep as much business logic as possible out of controllers.

* Use specialized classes to handle the operations
  * These will be Form Objects for the most part, since
  most of what the app does is process user input via a form submission, or
  clicking a link in email that contains a token.

* Form Object rules:
  - Should have a single public method called `submit` that returns a [FormResponse] object.
  - Should use ActiveModel validations to validate the user input.
  - Should be placed in `app/forms`.

* Examples of Form/Service Objects:
  - [EmailConfirmationTokenValidator]
  - [PasswordForm]

* The basic outline of how a controller interacts with this class is:
```ruby
result = Class.new(user).submit(params) # this returns a FormResponse object
# all the necessary analytics attributes are captured inside the Form Object
analytics.track_event('Some Event Name', result.to_h)

if result.success?
  handle_success
else
  handle_failure
end
```

* Only make one call to `analytics.track_event` after submitting the form, as
opposed to one call when handling success and another when handling failure. The
Form Object, when used properly, will return a FormResponse object that already
tells us whether the action was successful or not.

### Importance of the controller design for analytics

This design pattern was the result of many iterations, and agreed upon by all
team members in early 2017. It keeps controllers clean and predictable. Having a
controller interact with a Form Object or some other specialized class is not a
new concept. Rails developers have been using them since at least 2012. What
might seem new is the `FormResponse` object. **The most important reason
controllers expect an object that responds to `success?` and `to_h` is to define
an analytics API, or a contract, if you will, between the analytics logs and the
folks who query them.**

For example, if someone wants to look up all events that have failed, they would
run this query in Kibana: `properties.event_properties.success:false`. Now let's
say a developer introduces a new controller that doesn't adhere to our established
convention, and captures analytics in their own way, without adding `success`
and `errors` keys, which are expected to be included in all analytics events.
This means that any failures for this controller won't show up when running the
query above, and the person running the query might not realize data is missing.

Deviating from the convention also causes confusion. The next developer to join
the team will not be sure which pattern to use, and might end up picking the
wrong pattern. As Sandi Metz says:

> For better or for worse, the patterns you establish today will be replicated
forever. When the code lies you must be alert to programmers believing and then
propagating that lie.

### Secure controllers
Rails by default is currently vulnerable to [cache poisoning attacks]
through modification of the `X-Forwarded-For` and `Host` headers. In
order to protect against the latter, there are two pieces that must be
in place. The first one is already taken care of by defining
`default_url_options` in `ApplicationController` with a `host` value
that we control.

The other one is up to you when adding or modifying redirects:

- Always use `_url` helpers (as opposed to `_path`) when calling
`redirect_to` in a controller.

### Additional notes on pull requests and code reviews

Please follow our [Code Review][review] guidelines.
[Glen Sanford's thoughts on code reviews][thoughts] are also well worth
reading.

[review]: https://engineering.18f.gov/code-review/
[thoughts]: http://glen.nu/ramblings/oncodereview.php

- Prioritize code reviews for the current sprint above your other work
- Review pull requests for the current sprint within 24 hours of being opened
- Keep pull requests as small as possible, and focused on a single topic
- Once a pull request is good to go, the person who opened it squashes related
commits together, merges it, then deletes the branch.

### Recommended reading, viewing, and courses

- [Practical Object-Oriented Design in Ruby](http://www.poodr.com/)
- [99 Bottles of OOP](https://sandimetz.dpdcart.com/)
- [Sandi Metz blog](https://www.sandimetz.com/blog/)
- [Sandi Metz talks](https://www.youtube.com/playlist?list=PLFQBiiaZoyrcTBYAGAUjvEUI6TUrp110W)
- [Learn Clean Code](https://thoughtbot.com/upcase/clean-code)
- [Ruby Science](https://gumroad.com/l/ruby-science)
- [Ruby Tapas](https://www.rubytapas.com/)
- [Master the Object-Oriented Mindset in Ruby and Rails](https://avdi.codes/moom/)
- [Refactoring Rails](https://www.refactoringrails.io/)
- [Growing Rails Applications in Practice](https://pragprog.com/book/d-kegrap/growing-rails-applications-in-practice)
- [The 30-Day Code Quality Challenge](https://www.codequalitychallenge.com/)
- [SourceMaking](https://sourcemaking.com/)

## Public domain

This project is in the public domain within the United States, and
copyright and related rights in the work worldwide are waived through
the [CC0 1.0 Universal public domain dedication][CC0].

All contributions to this project will be released under the CC0
dedication. By submitting a pull request, you are agreeing to comply
with this waiver of copyright interest.

[CC0]: https://creativecommons.org/publicdomain/zero/1.0/
[FormResponse]: https://github.com/18F/identity-idp/blob/master/app/services/form_response.rb
[EmailConfirmationTokenValidator]: https://github.com/18F/identity-idp/blob/master/app/services/email_confirmation_token_validator.rb
[PasswordForm]: https://github.com/18F/identity-idp/blob/master/app/forms/password_form.rb
[cache poisoning attacks]: https://github.com/rails/rails/issues/29893
